#! /usr/bin/env -S luajit




-- Imports
package.path = package.path..";./?/init.lua"
local ml = require("ml")




-- Initialization
math.randomseed(os.time())

local nets = {}

for i = 0x01, 0x0400 do nets[i] = ml.neural_net.new(
    0x02,
    0x01,
    0x02,
    0x02,
    true,
    ml.activ.expit
) end

print(nets[0x01])




-- Machine Learning
local i = 0x01
local fitness = 0.0
while fitness < 0x0C do


    -- Generation Generation
    for j = 0x02, #nets do nets[j] = nets[0x01]:copy(0.5, 0.5) end


    -- Evaluation
    local fitnesses = {}
    for j = 0x01, #nets do
        fitnesses[j] = 0.0

        for k = 0x01, 0x20 do
            local input = {math.random()/0x02, math.random()/0x02}
            local output = {input[0x01]^0x02+input[0x02]^0x02}
            local result = nets[j]:run(input)

            for l = 0x01, #result do
                fitnesses[j] = fitnesses[j]+math.abs(result[l]-output[l])
            end
        end

        fitnesses[j] = 0x01/fitnesses[j]
    end


    -- Generation Sorting
    for j = 0x01, #nets do
        local k = j

        for l = j, #nets do if fitnesses[l] > fitnesses[k] then k = l end end

        fitnesses[j],   fitnesses[k]    = fitnesses[k], fitnesses[j]
        nets[j],        nets[k]         = nets[k],      nets[j]
    end


    -- Output
    fitness = fitnesses[0x01]
    io.write(i) io.write(" ") io.write(fitness) io.write("\r") io.flush()
    i = i+0x01
end




-- Testing
for i = 0x01, 0x08 do
    local input = {math.random()/0x02, math.random()/0x02}
    local output = {input[0x01]^0x02+input[0x02]^0x02}
    local result = nets[0x01]:run(input)

    print(table.concat(input, " ").." = "..table.concat(output, " "))
    print(table.concat(input, " ").." = "..table.concat(result, " "))
    print()
end
